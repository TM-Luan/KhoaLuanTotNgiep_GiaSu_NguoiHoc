# HÆ°á»›ng Dáº«n Há»‡ Thá»‘ng ÄÃ¡nh GiÃ¡ Gia SÆ°

## ğŸ“‹ Tá»•ng Quan

Há»‡ thá»‘ng Ä‘Ã¡nh giÃ¡ cho phÃ©p há»c viÃªn Ä‘Ã¡nh giÃ¡ gia sÆ° mÃ  há» Ä‘Ã£ hoáº·c Ä‘ang há»c. Má»—i há»c viÃªn chá»‰ cÃ³ thá»ƒ Ä‘Ã¡nh giÃ¡ **1 láº§n** cho má»—i gia sÆ° vÃ  cÃ³ thá»ƒ **chá»‰nh sá»­a khÃ´ng giá»›i háº¡n**.

## âœ… Quy Táº¯c ÄÃ¡nh GiÃ¡

### 1. Äiá»u kiá»‡n Ä‘Æ°á»£c Ä‘Ã¡nh giÃ¡
- Pháº£i Ä‘Äƒng nháº­p báº±ng tÃ i khoáº£n **NgÆ°á»i há»c**
- Pháº£i cÃ³ lá»›p há»c vá»›i gia sÆ° á»Ÿ tráº¡ng thÃ¡i:
  - `DangHoc` (Äang há»c)
  - `HoanThanh` (HoÃ n thÃ nh)

### 2. Giá»›i háº¡n Ä‘Ã¡nh giÃ¡
- âœ… **ÄÆ°á»£c**: ÄÃ¡nh giÃ¡ 1 láº§n cho má»—i gia sÆ°
- âœ… **ÄÆ°á»£c**: Chá»‰nh sá»­a Ä‘Ã¡nh giÃ¡ **1 Láº¦N DUY NHáº¤T**
- âŒ **KhÃ´ng Ä‘Æ°á»£c**: Táº¡o nhiá»u Ä‘Ã¡nh giÃ¡ cho cÃ¹ng 1 gia sÆ°
- âŒ **KhÃ´ng Ä‘Æ°á»£c**: Chá»‰nh sá»­a Ä‘Ã¡nh giÃ¡ quÃ¡ 1 láº§n

### 3. Ná»™i dung Ä‘Ã¡nh giÃ¡
- **Äiá»ƒm sá»‘**: Tá»« 1-5 sao (báº¯t buá»™c)
- **BÃ¬nh luáº­n**: Tá»‘i Ä‘a 1000 kÃ½ tá»± (tÃ¹y chá»n)

## ğŸ¯ Luá»“ng Sá»­ Dá»¥ng

### ÄÃ¡nh GiÃ¡ Láº§n Äáº§u

```
1. VÃ o trang chi tiáº¿t gia sÆ°
2. Click nÃºt "ÄÃ¡nh giÃ¡" (mÃ u vÃ ng)
3. Há»‡ thá»‘ng kiá»ƒm tra quyá»n
4. Chá»n sá»‘ sao (1-5)
5. Nháº­p bÃ¬nh luáº­n (náº¿u muá»‘n)
6. Click "Gá»­i Ä‘Ã¡nh giÃ¡"
7. Tá»± Ä‘á»™ng quay vá» trang chá»§
8. Danh sÃ¡ch gia sÆ° tá»± Ä‘á»™ng cáº­p nháº­t Ä‘iá»ƒm má»›i
```

### Chá»‰nh Sá»­a ÄÃ¡nh GiÃ¡

```
1. VÃ o trang chi tiáº¿t gia sÆ° Ä‘Ã£ Ä‘Ã¡nh giÃ¡
2. Click nÃºt "ÄÃ¡nh giÃ¡"
3. Há»‡ thá»‘ng kiá»ƒm tra:
   a) Náº¿u ÄÃƒ Sá»¬A Rá»’I:
      - Hiá»‡n dialog CHáº¶N vá»›i icon Ä‘á» ğŸš«
      - ThÃ´ng bÃ¡o: "KhÃ´ng thá»ƒ chá»‰nh sá»­a"
      - "Báº¡n Ä‘Ã£ sá»­a Ä‘Ã¡nh giÃ¡ nÃ y rá»“i. Má»—i há»c viÃªn chá»‰ Ä‘Æ°á»£c sá»­a 1 láº§n duy nháº¥t"
      - Chá»‰ cÃ³ nÃºt "ÄÃ³ng"
      
   b) Náº¿u CHÆ¯A Sá»¬A:
      - Hiá»‡n dialog Cáº¢NH BÃO vá»›i icon cam âš ï¸
      - Hiá»ƒn thá»‹ Ä‘Ã¡nh giÃ¡ hiá»‡n táº¡i
      - ThÃ´ng bÃ¡o: "LÆ¯U Ã: Báº¡n chá»‰ cÃ³ thá»ƒ sá»­a 1 Láº¦N DUY NHáº¤T"
      - Buttons: "Há»§y" | "TÃ´i hiá»ƒu, tiáº¿p tá»¥c sá»­a"
4. Click "TÃ´i hiá»ƒu, tiáº¿p tá»¥c sá»­a"
5. Dialog Ä‘Ã¡nh giÃ¡ hiá»‡n ra vá»›i dá»¯ liá»‡u cÅ©
6. Sá»­a Ä‘iá»ƒm hoáº·c bÃ¬nh luáº­n
7. Click "Gá»­i Ä‘Ã¡nh giÃ¡"
8. âš ï¸ SAU KHI Sá»¬A: KhÃ´ng thá»ƒ sá»­a ná»¯a
9. Tá»± Ä‘á»™ng quay vá» trang chá»§ vá»›i Ä‘iá»ƒm cáº­p nháº­t
```

## ğŸ”„ Auto Reload

Sau khi Ä‘Ã¡nh giÃ¡ thÃ nh cÃ´ng, há»‡ thá»‘ng tá»± Ä‘á»™ng:
- âœ… Reload chi tiáº¿t gia sÆ°
- âœ… Reload toÃ n bá»™ danh sÃ¡ch gia sÆ°
- âœ… Cáº­p nháº­t Ä‘iá»ƒm trung bÃ¬nh
- âœ… Cáº­p nháº­t sá»‘ lÆ°á»£ng Ä‘Ã¡nh giÃ¡
- âœ… Quay vá» trang chá»§ sau 1 giÃ¢y

## ğŸ“± Giao Diá»‡n

### NÃºt ÄÃ¡nh GiÃ¡
- MÃ u: **VÃ ng/Amber**
- Icon: â­ `star_rate`
- Vá»‹ trÃ­: DÆ°á»›i nÃºt "Xem Ä‘Ã¡nh giÃ¡"

### Dialog ÄÃ¡nh GiÃ¡
- Header: Avatar + TÃªn gia sÆ°
- Chá»n sao: 5 ngÃ´i sao tÆ°Æ¡ng tÃ¡c
- BÃ¬nh luáº­n: TextField vá»›i counter 0/1000
- Buttons: "Há»§y" | "ğŸ“¨ Gá»­i Ä‘Ã¡nh giÃ¡"

### Dialog Cáº£nh BÃ¡o Chá»‰nh Sá»­a (ChÆ°a sá»­a láº§n nÃ o)
- Icon: ğŸ”– `edit_note` (mÃ u cam)
- Hiá»ƒn thá»‹ Ä‘Ã¡nh giÃ¡ cÅ©: Äiá»ƒm + BÃ¬nh luáº­n
- ThÃ´ng bÃ¡o: **LÆ¯U Ã: Chá»‰ Ä‘Æ°á»£c sá»­a 1 Láº¦N DUY NHáº¤T**
- Buttons: "Há»§y" | "âš ï¸ TÃ´i hiá»ƒu, tiáº¿p tá»¥c sá»­a"

### Dialog Cháº·n (ÄÃ£ sá»­a rá»“i)
- Icon: ğŸš« `block` (mÃ u Ä‘á»)
- Hiá»ƒn thá»‹ Ä‘Ã¡nh giÃ¡ hiá»‡n táº¡i: Äiá»ƒm + BÃ¬nh luáº­n
- ThÃ´ng bÃ¡o Ä‘á»: **"ÄÃ£ sá»­a rá»“i, khÃ´ng thá»ƒ sá»­a ná»¯a"**
- Chá»‰ cÃ³ nÃºt: "ÄÃ³ng"

## ğŸ¨ Hiá»ƒn Thá»‹ Äiá»ƒm

### TrÃªn Card Gia SÆ°
```
4.5 â­ (23)
â””â”€â”€ Äiá»ƒm TB   â””â”€â”€ Sá»‘ Ä‘Ã¡nh giÃ¡
```

### TrÃªn Trang Chi Tiáº¿t
```
Äiá»ƒm Ä‘Ã¡nh giÃ¡: 4.5 â­â­â­â­â­
```

### Trang Danh SÃ¡ch ÄÃ¡nh GiÃ¡
```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  4.5 â­â­â­â­â­              â”‚
â”‚  23 Ä‘Ã¡nh giÃ¡                â”‚
â”‚                             â”‚
â”‚  5â­ â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆ 15        â”‚
â”‚  4â­ â–ˆâ–ˆâ–ˆâ–ˆâ–ˆ 5                â”‚
â”‚  3â­ â–ˆâ–ˆ 2                   â”‚
â”‚  2â­ â–ˆ 1                    â”‚
â”‚  1â­ â–‘ 0                    â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

## ğŸ”§ Technical Details

### Backend API

1. **POST** `/api/danhgia`
   - Táº¡o hoáº·c cáº­p nháº­t Ä‘Ã¡nh giÃ¡
   - Validate: Há»c viÃªn Ä‘Ã£ há»c vá»›i gia sÆ°
   - Logic: TÃ¬m Ä‘Ã¡nh giÃ¡ cÅ© â†’ Update hoáº·c Create

2. **GET** `/api/danhgia/kiem-tra-danh-gia?gia_su_id={id}`
   - Kiá»ƒm tra quyá»n Ä‘Ã¡nh giÃ¡
   - Tráº£ vá»: `co_the_danh_gia`, `da_danh_gia`, `danh_gia`

3. **GET** `/api/giasu/{id}/danhgia`
   - Láº¥y táº¥t cáº£ Ä‘Ã¡nh giÃ¡ cá»§a gia sÆ°
   - Public endpoint

4. **DELETE** `/api/danhgia/{id}`
   - XÃ³a Ä‘Ã¡nh giÃ¡ (chÆ°a dÃ¹ng trong UI)

### Frontend Flow

```dart
// 1. Kiá»ƒm tra quyá»n
context.read<DanhGiaBloc>().add(KiemTraDaDanhGia(giaSuId: id));

// 2. Hiá»‡n dialog vá»›i dá»¯ liá»‡u cÅ© (náº¿u cÃ³)
showDialog<bool>(
  builder: (context) => DanhGiaGiaSuDialog(
    tutor: tutor,
    initialRating: oldRating,
    initialComment: oldComment,
  ),
);

// 3. Submit Ä‘Ã¡nh giÃ¡
context.read<DanhGiaBloc>().add(TaoDanhGia(
  giaSuId: id,
  diemSo: rating,
  binhLuan: comment,
));

// 4. Reload dá»¯ liá»‡u
context.read<TutorBloc>().add(LoadTutorByIdEvent(id));
context.read<TutorBloc>().add(LoadAllTutorsEvent());

// 5. Quay vá» trang chá»§
Navigator.pop(context);
```

## ğŸ› Troubleshooting

### KhÃ´ng tháº¥y nÃºt "ÄÃ¡nh giÃ¡"
- âœ… Check: ÄÃ£ Ä‘Äƒng nháº­p báº±ng tÃ i khoáº£n NgÆ°á»i há»c chÆ°a?
- âœ… Check: Provider `DanhGiaBloc` Ä‘Ã£ Ä‘Æ°á»£c Ä‘Äƒng kÃ½ trong `main.dart` chÆ°a?

### KhÃ´ng thá»ƒ Ä‘Ã¡nh giÃ¡
- âœ… Check: CÃ³ lá»›p há»c vá»›i gia sÆ° á»Ÿ tráº¡ng thÃ¡i `DangHoc` hoáº·c `HoanThanh` chÆ°a?
- âœ… Check: Backend API `/api/danhgia/kiem-tra-danh-gia` tráº£ vá» gÃ¬?

### Danh sÃ¡ch khÃ´ng tá»± Ä‘á»™ng cáº­p nháº­t
- âœ… Check: `BlocBuilder<TutorBloc>` Ä‘Ã£ Ä‘Æ°á»£c setup Ä‘Ãºng chÆ°a?
- âœ… Check: `LoadAllTutorsEvent` Ä‘Ã£ Ä‘Æ°á»£c dispatch sau khi Ä‘Ã¡nh giÃ¡ chÆ°a?

### Äiá»ƒm khÃ´ng Ä‘Ãºng
- âœ… Check: Backend tÃ­nh Ä‘iá»ƒm trung bÃ¬nh cÃ³ Ä‘Ãºng khÃ´ng?
- âœ… Check: `GiaSuResource` cÃ³ tÃ­nh `DiemSo` vÃ  `TongSoDanhGia` chÆ°a?

## ğŸ“Š Database Schema

```sql
DanhGia
â”œâ”€â”€ DanhGiaID (PK)
â”œâ”€â”€ LopYeuCauID (FK -> LopHocYeuCau)
â”œâ”€â”€ TaiKhoanID (FK -> TaiKhoan)
â”œâ”€â”€ DiemSo (1-5)
â”œâ”€â”€ BinhLuan (max 1000 chars)
â”œâ”€â”€ NgayDanhGia (datetime)
â”œâ”€â”€ created_at (datetime) -- Thá»i Ä‘iá»ƒm táº¡o
â””â”€â”€ updated_at (datetime) -- Thá»i Ä‘iá»ƒm cáº­p nháº­t

Unique constraint: (LopYeuCauID, TaiKhoanID)
Logic: created_at != updated_at => ÄÃ£ sá»­a rá»“i
```

## âœ¨ Features Implemented

- âœ… ÄÃ¡nh giÃ¡ gia sÆ° vá»›i sao vÃ  bÃ¬nh luáº­n
- âœ… Giá»›i háº¡n 1 Ä‘Ã¡nh giÃ¡/há»c viÃªn/gia sÆ°
- âœ… Chá»‰nh sá»­a Ä‘Ã¡nh giÃ¡ **1 Láº¦N DUY NHáº¤T**
- âœ… Dialog cáº£nh bÃ¡o rÃµ rÃ ng khi sá»­a
- âœ… Dialog cháº·n náº¿u Ä‘Ã£ sá»­a rá»“i
- âœ… Backend validate báº±ng `created_at` vs `updated_at`
- âœ… Auto reload danh sÃ¡ch sau khi Ä‘Ã¡nh giÃ¡
- âœ… Hiá»ƒn thá»‹ Ä‘iá»ƒm trung bÃ¬nh trÃªn card
- âœ… Trang xem táº¥t cáº£ Ä‘Ã¡nh giÃ¡
- âœ… PhÃ¢n bá»‘ Ä‘iá»ƒm theo sao
- âœ… Validate quyá»n Ä‘Ã¡nh giÃ¡

## ğŸ‰ Done!

Há»‡ thá»‘ng Ä‘Ã¡nh giÃ¡ Ä‘Ã£ hoÃ n thiá»‡n vá»›i Ä‘áº§y Ä‘á»§ tÃ­nh nÄƒng:
- Giá»›i háº¡n Ä‘Ã¡nh giÃ¡ Ä‘Ãºng quy táº¯c
- Auto reload thÃ´ng minh
- UX/UI mÆ°á»£t mÃ 
- Validation cháº·t cháº½
